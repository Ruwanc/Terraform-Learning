/*
████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░██████████░░░░░░█
█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░░░░░░░░░░░░░▄▀░░█
█░░░░░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀▄▀▄▀▄▀▄▀▄▀▄▀▄▀▄▀░░█
█████░░▄▀░░█████░░▄▀░░█████████░░▄▀░░████░░▄▀░░███░░▄▀░░████░░▄▀░░███░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░░░░░▄▀░░░░░░▄▀░░█
█████░░▄▀░░█████░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░██░░▄▀░░██░░▄▀░░█
█████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀░░██░░▄▀░░██░░▄▀░░█
█████░░▄▀░░█████░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░██░░░░░░██░░▄▀░░█
█████░░▄▀░░█████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█████░░▄▀░░██░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░██████████░░▄▀░░█
█████░░▄▀░░█████░░▄▀░░░░░░░░░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░██████████░░▄▀░░█
█████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀░░██████████░░▄▀░░█
█████░░░░░░█████░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░█████████░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░██████████░░░░░░█
████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
███████████████████████████████████████████████████████████████████████████████████████████████████
█░░░░░░██████████░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░███░░░░░░██░░░░░░█░░░░░░█████████░░░░░░░░░░░░░░█
█░░▄▀░░░░░░░░░░░░░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀▄▀▄▀▄▀▄▀░░█
█░░▄▀▄▀▄▀▄▀▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░░░░░░░░░█
█░░▄▀░░░░░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████
█░░▄▀░░██░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░░░░░░░░░█
█░░▄▀░░██░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀▄▀▄▀▄▀▄▀░░█
█░░▄▀░░██░░░░░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░░░░░░░░░█
█░░▄▀░░██████████░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████
█░░▄▀░░██████████░░▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░▄▀▄▀░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█
█░░▄▀░░██████████░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀░░░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
█░░░░░░██████████░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░███░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█
███████████████████████████████████████████████████████████████████████████████████████████████████
*/

## Keep this terraform block in the main.tf file of the module
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "5.92.0"
    }
  }
}


#---------------------------------define lacal variables start-------------------------------------

locals {
  server_port = 80
  tcp_protocol = "tcp"
  any_port = 0
  all_protocol = "-1" # semantically equivalent to all protocols
  #all_ips = ["0.0.0.0/0"]
  all_ips = "0.0.0.0/0"
}

#---------------------------------define lacal variables end-------------------------------------
#Add Auto Scaling Group (ASG) with aws launch template
#launch template
resource "aws_launch_template" "web-server-launch-template" {
  name                 = "${var.web_server_cluster_name}-lt"
  image_id             = "ami-0b8eb446c5e792d0d"
  instance_type        = var.launch_template_instance_type
  security_group_names = [aws_security_group.ec2_instance_sg.name]
  user_data = base64encode(templatefile("${path.module}/script.tftpl", {
    server_port = local.server_port,
    # db_address  = data.terraform_remote_state.mysql_rds_db_datasource.outputs.address,
    # db_port     = data.terraform_remote_state.mysql_rds_db_datasource.outputs.port
    db_address  = var.mysql_db_address_variable,
    db_port     = var.mysql_db_port_variable
  }))
  key_name = "aws_key_mumbai_region"

  lifecycle {
    create_before_destroy = true
  }
}

#autoscaling group
resource "aws_autoscaling_group" "web-server-autoscaling-group" {
  availability_zones = ["ap-south-1a", "ap-south-1b"]
  desired_capacity   = 1
  #vpc_zone_identifier = data.aws_subnets.default.ids
  max_size = var.auto_scaling_group_max_size
  min_size = var.auto_scaling_group_min_size

  target_group_arns = [aws_lb_target_group.target_group.arn]
  health_check_type = "ELB"

  launch_template {
    id      = aws_launch_template.web-server-launch-template.id
    version = "$Latest"
  }
  tag {
    key                 = "Name"
    value               = "${var.web_server_cluster_name}-terraform-asg-example"
    propagate_at_launch = true
  }
}

resource "aws_lb" "web-server-lb" {
  name               = "${var.web_server_cluster_name}-app-lb"
  load_balancer_type = "application"
  security_groups    = [aws_security_group.lb-sg.id]
  subnets            = data.aws_subnets.default.ids
}

#define loadbalancer listener
resource "aws_lb_listener" "http-ls" {
  load_balancer_arn = aws_lb.web-server-lb.arn
  port              = local.server_port
  protocol          = "HTTP"

  default_action {
    type = "fixed-response"

    fixed_response {
      content_type = "text/plain"
      message_body = "404: page not found"
      status_code  = 404
    }
  }
}

#define lb_target group for asg
resource "aws_lb_target_group" "target_group" {
  name     = "${var.web_server_cluster_name}-tf-asg-tg"
  port     = local.server_port
  protocol = "HTTP"
  vpc_id   = data.aws_vpc.default.id

  health_check {
    path                = "/"
    protocol            = "HTTP"
    matcher             = "200"
    interval            = 15
    timeout             = 3
    healthy_threshold   = 2
    unhealthy_threshold = 2
  }
}

#listener rule
resource "aws_lb_listener_rule" "asg" {
  listener_arn = aws_lb_listener.http-ls.arn
  priority     = 100

  condition {
    path_pattern {
      values = ["*"]
    }
  }
  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.target_group.arn
  }
}

/*
#create EC2 instance
resource "aws_instance" "web" {
  ami                    = "ami-0b8eb446c5e792d0d"
  instance_type          = "t3.micro"
  vpc_security_group_ids = [aws_security_group.ec2_instance_sg.id]

  tags = {
    Name = "HelloWorld"
  }

  user_data = <<-EOF
              #!/bin/bash
              echo "Hello world" > index.html
              nohup busybox httpd -f -p 8080 &
              EOF

  user_data_replace_on_change = true
}
*/
resource "aws_security_group" "ec2_instance_sg" {
  name        = "${var.web_server_cluster_name}-terraform-example-sg"
  description = "Allow inbound http and ssh traffic & alloutbound traffic to ec2"
  vpc_id      = data.aws_vpc.default.id

  # ingress {
  #   from_port   = var.server_port
  #   to_port     = var.server_port
  #   protocol    = "tcp"
  #   cidr_blocks = ["0.0.0.0/0"]
  # }
}

#allow port 80 from public internet
resource "aws_vpc_security_group_ingress_rule" "allow_tls_ipv4" {
  security_group_id = aws_security_group.ec2_instance_sg.id
  cidr_ipv4         = local.all_ips #"0.0.0.0/0"
  from_port         = local.server_port
  ip_protocol       = "tcp"
  to_port           = local.server_port
}

#allow ssh for ec2
resource "aws_vpc_security_group_ingress_rule" "allow_tls_ipv4_ec2ssh" {
  security_group_id = aws_security_group.ec2_instance_sg.id
  cidr_ipv4         = local.all_ips #"0.0.0.0/0"
  from_port         = 22
  ip_protocol       = local.tcp_protocol #"tcp"
  to_port           = 22
}

resource "aws_vpc_security_group_egress_rule" "allow_all_traffic_ipv4_ec2" {
  security_group_id = aws_security_group.ec2_instance_sg.id
  cidr_ipv4         = local.all_ips #"0.0.0.0/0"
  ip_protocol       = local.all_protocol #"-1" # semantically equivalent to all protocols
}

#security group for loadbalancer
resource "aws_security_group" "lb-sg" {
  name        = "${var.web_server_cluster_name}-terraform-sg-lb"
  description = "SG for loadbalancer"
  vpc_id      = data.aws_vpc.default.id
  #allow inbound traffic
  # ingress {
  #   from_port   = 80
  #   to_port     = 80
  #   protocol    = "tcp"
  #   cidr_blocks = ["0.0.0.0/0"]
  # }
  #allow ssh
  # ingress {
  #   from_port   = 0
  #   to_port     = 22
  #   protocol    = "tcp"
  #   cidr_blocks = ["0.0.0.0/0"]
  # }
  #allow all outbound requests
  # egress {
  #   from_port   = 0
  #   to_port     = 0
  #   protocol    = "tcp"
  #   cidr_blocks = ["0.0.0.0/0"]
  # }
}

#allow port 80 from public internet
resource "aws_vpc_security_group_ingress_rule" "allow_tls_ipv4_lb" {
  security_group_id = aws_security_group.lb-sg.id
  cidr_ipv4         = local.all_ips #"0.0.0.0/0"
  from_port         = local.server_port
  ip_protocol       = "tcp"
  to_port           = local.server_port
}

resource "aws_vpc_security_group_egress_rule" "allow_all_traffic_ipv4_lb" {
  security_group_id = aws_security_group.lb-sg.id
  cidr_ipv4         = local.all_ips #"0.0.0.0/0"
  ip_protocol       = local.all_protocol #"-1" # semantically equivalent to all ports
}